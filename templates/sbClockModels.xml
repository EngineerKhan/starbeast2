<beast version="2.0" namespace="beast.app.beauti:beast.core:beast.evolution.branchratemodel:beast.evolution.speciation:beast.evolution.tree.coalescent:beast.core.util:beast.evolution.nuc:beast.evolution.operators:beast.evolution.sitemodel:beast.evolution.substitutionmodel:beast.evolution.likelihood:beast.evolution:beast.math.distributions">
	<!-- Clock models -->
	<mergewith point="sbClockModelTemplates">
		<!-- Plain ol' strict clock -->
		<subtemplate id="StrictClock" class="beast.evolution.branchratemodel.StrictClockModel" mainid="StrictClock.c:$(n)">
<![CDATA[
			<branchRateModel spec="StrictClockModel" id="StrictClock.c:$(n)">
				<clock.rate id="clockRate.c:$(n)" spec="parameter.RealParameter" lower="0.0" value="1.0" estimate="true"/>
			</branchRateModel>

			<operator id="clockRateScaler.c:$(n)" spec="ScaleOperator" scaleFactor="0.5" weight="3.0" parameter="@clockRate.c:$(n)"/>

			<upDownOperator id="clockUpDownOperator.c:$(n)" spec="UpDownOperator" scaleFactor="0.95" weight="3.0">
				<up idref="clockRate.c:$(n)"/>
				<down idref="Tree.t:$(n)"/>
			</upDownOperator>

			<prior id="clockRatePrior.c:$(n)" x="@clockRate.c:$(n)">
				<distr spec="beast.math.distributions.Exponential">
					<mean id="clockRatePriorMean.s:$(n)" spec="parameter.RealParameter" lower="0.0" value="1.0" estimate="false"/>
				</distr>
			</prior>
]]>

			<connect srcID="clockRate.c:$(n)" targetID="state" inputName="stateNode" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true"/>
			<connect srcID="clockRatePrior.c:$(n)" targetID="prior" inputName="distribution" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true">
				Prior on the overall clock rate of partition c:$(n)
			</connect>
			<connect srcID="clockRateScaler.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true">
				Scale substitution rate of partition c:$(n)
			</connect>
			<connect srcID="clockUpDownOperator.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(clockRate.c:$(n)) and inlikelihood(Tree.t:$(n)) and Tree.t:$(n)/estimate=true and clockRate.c:$(n)/estimate=true">
				Scale up substitution rate c:$(n) and scale down tree t:$(n)
			</connect>

			<connect srcID="clockRate.c:$(n)" targetID="tracelog" inputName="log" if="inposterior(StrictClock.c:$(n))"/>
		</subtemplate>

		<!-- UCLN relaxed clock that applies to each gene tree branch -->
		<subtemplate id="Uncorrelated Lognormal" class="starbeast2.UncorrelatedRates" mainid="GeneTreeUCLN.c:$(n)">
<![CDATA[
			<branchRateModel estimateRoot="false" id="GeneTreeUCLN.c:$(n)" spec="starbeast2.UncorrelatedRates" tree="@Tree.t:$(n)">
				<clock.rate id="clockRate.c:$(n)" spec="parameter.RealParameter" lower="0.0" value="1.0" estimate="true"/>
				<rates dimension="10" value="1" estimate="true" id="branchRates.c:$(n)" spec="parameter.IntegerParameter"/>
				<parameter name="stdev" id="branchRatesStdev.c:$(n)" lower="0.01" value="0.32" estimate="true" />
			</branchRateModel>

			<operator id="clockRateScaler.c:$(n)" spec="ScaleOperator" scaleFactor="0.5" weight="3.0" parameter="@clockRate.c:$(n)"/>
			<operator id="branchRatesStdevScaler.c:$(n)" spec="ScaleOperator" scaleFactor="0.75" weight="3.0" parameter="@branchRatesStdev.c:$(n)"/>

			<upDownOperator id="clockUpDownOperator.c:$(n)" spec="UpDownOperator" scaleFactor="0.95" weight="3.0">
				<up idref="clockRate.c:$(n)"/>
				<down idref="Tree.t:$(n)"/>
			</upDownOperator>

			<operator id="branchRatesCycle.c:$(n)" k="2" optimise="false" spec="starbeast2.DiscreteRateCycle" treeRates="@branchRates.c:$(n)" weight="9.0" />
			<operator id="branchRatesUniform.c:$(n)" k="1" optimise="false" spec="starbeast2.DiscreteRateUniform" treeRates="@branchRates.c:$(n)" weight="9.0" />

			<prior id="clockRatePrior.c:$(n)" x="@clockRate.c:$(n)">
				<distr spec="beast.math.distributions.Exponential">
					<mean id="clockRatePriorMean.s:$(n)" spec="parameter.RealParameter" lower="0.0" value="1.0" estimate="false"/>
				</distr>
			</prior>

			<prior id="branchRatesStdevPrior.c:$(n)" x="@branchRatesStdev.c:$(n)">
				<distr spec="beast.math.distributions.Exponential">
					<mean id="branchRatesStdevPriorMean.s:$(n)" spec="parameter.RealParameter" lower="0.0" value="1.0" estimate="false"/>
				</distr>
			</prior>
]]>
			<connect srcID="clockRate.c:$(n)" targetID="state" inputName="stateNode" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true"/>
			<connect srcID="branchRates.c:$(n)" targetID="state" inputName="stateNode" if="inlikelihood(branchRates.c:$(n)) and branchRates.c:$(n)/estimate=true"/>
			<connect srcID="branchRatesStdev.c:$(n)" targetID="state" inputName="stateNode" if="inlikelihood(branchRates.c:$(n)) and branchRatesStdev.c:$(n)/estimate=true"/>

			<connect srcID="clockRatePrior.c:$(n)" targetID="prior" inputName="distribution" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true">
				Prior on the overall clock rate of partition c:$(n)
			</connect>
			<connect srcID="branchRatesStdevPrior.c:$(n)" targetID="prior" inputName="distribution" if="inlikelihood(branchRates.c:$(n)) and branchRatesStdev.c:$(n)/estimate=true">
				Prior on the spread of branch rates of partition c:$(n)
			</connect>

			<connect srcID="clockRateScaler.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true">
				Scale substitution rate of partition c:$(n)
			</connect>
			<connect srcID="clockUpDownOperator.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(clockRate.c:$(n)) and inlikelihood(Tree.t:$(n)) and Tree.t:$(n)/estimate=true and clockRate.c:$(n)/estimate=true">
				Scale up substitution rate c:$(n) and scale down tree t:$(n)
			</connect>
			<connect srcID="branchRatesStdevScaler.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(branchRates.c:$(n)) and branchRatesStdev.c:$(n)/estimate=true">
				Scale substitution rate of partition c:$(n)
			</connect>

			<connect srcID="branchRatesCycle.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(branchRates.c:$(n)) and branchRates.c:$(n)/estimate=true">
				Cycle the substitution rates around a subset of branches by one step
			</connect>
			<connect srcID="branchRatesUniform.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(branchRates.c:$(n)) and branchRates.c:$(n)/estimate=true">
				Sample the substitution rate category uniformly
			</connect>

			<connect srcID="clockRate.c:$(n)" targetID="tracelog" inputName="log" if="inposterior(GeneTreeUCLN.c:$(n))"/>
			<connect srcID="branchRatesStdev.c:$(n)" targetID="tracelog" inputName="log" if="inlikelihood(branchRates.c:$(n)) and branchRatesStdev.c:$(n)/estimate=true"/>

			<connect srcID="GeneTreeUCLN.c:$(n)" targetID="TreeWithMetaDataLogger.t:$(n)" inputName="branchratemodel" if="inlikelihood(GeneTreeUCLN.c:$(n))"/>
		</subtemplate>

		<!-- UCED relaxed clock that applies to each gene tree branch -->
		<subtemplate id="Uncorrelated Exponential" class="starbeast2.UncorrelatedRates" mainid="GeneTreeUCED.c:$(n)">
<![CDATA[
			<branchRateModel estimateRoot="false" id="GeneTreeUCED.c:$(n)" spec="starbeast2.UncorrelatedRates" tree="@Tree.t:$(n)">
				<clock.rate id="clockRate.c:$(n)" spec="parameter.RealParameter" lower="0.0" value="1.0" estimate="true"/>
				<rates dimension="10" value="1" estimate="true" id="branchRates.c:$(n)" spec="parameter.IntegerParameter"/>
			</branchRateModel>

			<operator id="clockRateScaler.c:$(n)" spec="ScaleOperator" scaleFactor="0.5" weight="3.0" parameter="@clockRate.c:$(n)"/>

			<upDownOperator id="clockUpDownOperator.c:$(n)" spec="UpDownOperator" scaleFactor="0.95" weight="3.0">
				<up idref="clockRate.c:$(n)"/>
				<down idref="Tree.t:$(n)"/>
			</upDownOperator>

			<operator id="branchRatesCycle.c:$(n)" k="2" optimise="false" spec="starbeast2.DiscreteRateCycle" treeRates="@branchRates.c:$(n)" weight="9.0" />
			<operator id="branchRatesUniform.c:$(n)" k="1" optimise="false" spec="starbeast2.DiscreteRateUniform" treeRates="@branchRates.c:$(n)" weight="9.0" />

			<prior id="clockRatePrior.c:$(n)" x="@clockRate.c:$(n)">
				<distr spec="beast.math.distributions.Exponential">
					<mean id="clockRatePriorMean.s:$(n)" spec="parameter.RealParameter" lower="0.0" value="1.0" estimate="false"/>
				</distr>
			</prior>
]]>
			<connect srcID="clockRate.c:$(n)" targetID="state" inputName="stateNode" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true"/>
			<connect srcID="branchRates.c:$(n)" targetID="state" inputName="stateNode" if="inlikelihood(branchRates.c:$(n)) and branchRates.c:$(n)/estimate=true"/>

			<connect srcID="clockRatePrior.c:$(n)" targetID="prior" inputName="distribution" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true">
				Prior on the overall clock rate of partition c:$(n)
			</connect>

			<connect srcID="clockRateScaler.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true">
				Scale substitution rate of partition c:$(n)
			</connect>
			<connect srcID="clockUpDownOperator.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(clockRate.c:$(n)) and inlikelihood(Tree.t:$(n)) and Tree.t:$(n)/estimate=true and clockRate.c:$(n)/estimate=true">
				Scale up substitution rate c:$(n) and scale down tree t:$(n)
			</connect>

			<connect srcID="branchRatesCycle.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(branchRates.c:$(n)) and branchRates.c:$(n)/estimate=true">
				Cycle the substitution rates around a subset of branches by one step
			</connect>
			<connect srcID="branchRatesUniform.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(branchRates.c:$(n)) and branchRates.c:$(n)/estimate=true">
				Sample the substitution rate category uniformly
			</connect>

			<connect srcID="clockRate.c:$(n)" targetID="tracelog" inputName="log" if="inposterior(GeneTreeUCED.c:$(n))"/>

			<connect srcID="GeneTreeUCED.c:$(n)" targetID="TreeWithMetaDataLogger.t:$(n)" inputName="branchratemodel" if="inlikelihood(GeneTreeUCED.c:$(n))"/>
		</subtemplate>

		<!-- RLC relaxed clock that applies to each gene tree branch -->
		<subtemplate id="Random Local Clock" class="starbeast2.RandomLocalRates" mainid="GeneTreeRLC.c:$(n)">
<![CDATA[
			<branchRateModel id="GeneTreeRLC.c:$(n)" spec="starbeast2.RandomLocalRates" tree="@Tree.t:$(n)">
				<clock.rate id="clockRate.c:$(n)" spec="parameter.RealParameter" lower="0.0" value="1.0" estimate="true"/>
				<rates dimension="10" value="1.0" estimate="true" id="branchRates.c:$(n)" spec="parameter.RealParameter"/>
				<indicators dimension="10" value="true" estimate="true" id="indicators.c:$(n)" spec="parameter.BooleanParameter"/>
			</branchRateModel>

			<operator id="clockRateScaler.c:$(n)" spec="ScaleOperator" scaleFactor="0.5" weight="3.0" parameter="@clockRate.c:$(n)"/>

			<upDownOperator id="clockUpDownOperator.c:$(n)" spec="UpDownOperator" scaleFactor="0.95" weight="3.0">
				<up idref="clockRate.c:$(n)"/>
				<down idref="Tree.t:$(n)"/>
			</upDownOperator>

			<operator id="branchRateScaler.c:$(n)" spec="ScaleOperator" scaleFactor="0.5" parameter="@branchRates.c:$(n)" weight="9.0"/>
			<operator id="indicatorFlipper.c:$(n)" spec="BitFlipOperator" parameter="@indicators.c:$(n)" weight="9.0"/>

			<prior id="clockRatePrior.c:$(n)" x="@clockRate.c:$(n)">
				<distr spec="beast.math.distributions.Exponential">
					<mean id="clockRatePriorMean.s:$(n)" spec="parameter.RealParameter" lower="0.0" value="1.0" estimate="false"/>
				</distr>
			</prior>

			<prior id="branchRatePrior.c:$(n)" name="distribution" x="@branchRates.c:$(n)">
				<distr spec="beast.math.distributions.Gamma">
					<parameter estimate="false" id="branchRatePriorAlpha.$(n)" name="alpha" lower="0.0" value="0.5"/>
					<parameter estimate="false" id="branchRatePriorBeta.$(n)" name="beta" lower="0.0" value="2.0"/>
				</distr>
			</prior>

			<prior id="indicatorSumPrior.c:$(n)" name="distribution">
				<x id="indicatorSum.c:$(n)" spec="beast.core.util.Sum" arg="@indicators.c:$(n)"/>
				<distr spec="beast.math.distributions.Poisson">
					<lambda spec="parameter.RealParameter" estimate="false" value="0.6931471805599453"/>
				</distr>
			</prior>
]]>
			<connect srcID="clockRate.c:$(n)" targetID="state" inputName="stateNode" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true"/>
			<connect srcID="branchRates.c:$(n)" targetID="state" inputName="stateNode" if="inlikelihood(branchRates.c:$(n)) and branchRates.c:$(n)/estimate=true"/>
			<connect srcID="indicators.c:$(n)" targetID="state" inputName="stateNode" if="inlikelihood(indicators.c:$(n)) and indicators.c:$(n)/estimate=true"/>

			<connect srcID="clockRatePrior.c:$(n)" targetID="prior" inputName="distribution" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true">
				Prior on the overall clock rate of partition c:$(n)
			</connect>

			<connect srcID="branchRatePrior.c:$(n)" targetID="prior" inputName="distribution" if="inlikelihood(branchRates.c:$(n)) and branchRates.c:$(n)/estimate=true"/>
			<connect srcID="indicatorSumPrior.c:$(n)" targetID="prior" inputName="distribution" if="inlikelihood(indicators.c:$(n)) and indicators.c:$(n)/estimate=true"/>

			<connect srcID="clockRateScaler.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(clockRate.c:$(n)) and clockRate.c:$(n)/estimate=true">
				Scale substitution rate of partition c:$(n)
			</connect>
			<connect srcID="clockUpDownOperator.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(clockRate.c:$(n)) and inlikelihood(Tree.t:$(n)) and Tree.t:$(n)/estimate=true and clockRate.c:$(n)/estimate=true">
				Scale up substitution rate c:$(n) and scale down tree t:$(n)
			</connect>

			<connect srcID="branchRateScaler.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(branchRates.c:$(n)) and branchRates.c:$(n)/estimate=true">
				Scale individual branch rates
			</connect>
			<connect srcID="indicatorFlipper.c:$(n)" targetID="mcmc" inputName="operator" if="inlikelihood(indicators.c:$(n)) and indicators.c:$(n)/estimate=true">
				Turn branch rate indicators on or off for more or less branch rate changes
			</connect>

			<connect srcID="clockRate.c:$(n)" targetID="tracelog" inputName="log" if="inposterior(GeneTreeRLC.c:$(n))"/>

			<connect srcID="GeneTreeRLC.c:$(n)" targetID="TreeWithMetaDataLogger.t:$(n)" inputName="branchratemodel" if="inlikelihood(GeneTreeRLC.c:$(n))"/>
		</subtemplate>
	</mergewith>
</beast>
