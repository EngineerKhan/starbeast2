<beast version="2.0" namespace="beast.app.beauti:beast.core:beast.evolution.branchratemodel:beast.evolution.speciation:beast.evolution.tree.coalescent:beast.core.util:beast.evolution.nuc:beast.evolution.operators:beast.evolution.sitemodel:beast.evolution.substitutionmodel:beast.evolution.likelihood:beast.evolution:beast.math.distributions">
	<!-- population model priors -->
	<mergewith point="sbPopModelTemplates">
		<!-- Analytical integration of per-branch effective population sizes -->
		<subtemplate id="AnalyticalPopulationSizeIntegration" class="starbeast2.DummyModel" mainid="constantPopIOModel.$(n)">
<![CDATA[
			<plugin id="constantPopIOModel.$(n)" spec="starbeast2.DummyModel"/>

			<parameter name="alpha" id="popShape.$(n)" lower="0.0" value="3.0" estimate="false"/>
			<parameter name="mean" id="popMean.$(n)" lower="0.0" value="1.0" estimate="true"/>

			<distribution id="popShapePrior.$(n)" spec="beast.math.distributions.Prior" x="@popShape.$(n)">
				<distr spec="beast.math.distributions.Uniform" lower="0.0" upper="10000.0"/>
			</distribution>

			<distribution id="popMeanPrior.$(n)" spec="beast.math.distributions.Prior" x="@popMean.$(n)">
				<distr spec="beast.math.distributions.OneOnX"/>
			</distribution>

			<operator id="popShapeScale.$(n)" parameter="@popShape.$(n)" scaleFactor="0.75" spec="ScaleOperator" weight="1.0"/>
			<operator id="popMeanScale.$(n)" parameter="@popMean.$(n)" scaleFactor="0.75" spec="ScaleOperator" weight="1.0"/>
]]>

			<connect srcID="constantPopIOModel.Species" targetID="popModelBridge.Species" inputName="childModel" if="inposterior(constantPopIOModel.Species)"/>

			<connect srcID="popShape.Species" targetID="speciescoalescent" inputName="populationShape" if="inposterior(constantPopIOModel.Species)"/>
			<connect srcID="popMean.Species" targetID="speciescoalescent" inputName="populationMean" if="inposterior(constantPopIOModel.Species)"/>

			<connect srcID="popShape.Species" targetID="state" inputName="stateNode" if="inposterior(constantPopIOModel.Species) and popShape.Species/estimate=true"/>
			<connect srcID="popMean.Species" targetID="state" inputName="stateNode" if="inposterior(constantPopIOModel.Species) and popMean.Species/estimate=true"/>

			<connect srcID="popShapePrior.Species" targetID="prior" inputName="distribution" if="inposterior(constantPopIOModel.Species) and popShape.Species/estimate=true"/>
			<connect srcID="popMeanPrior.Species" targetID="prior" inputName="distribution" if="inposterior(constantPopIOModel.Species) and popMean.Species/estimate=true"/>

			<connect srcID="popShapeScale.Species" targetID="mcmc" inputName="operator" if="inposterior(constantPopIOModel.Species) and popShape.Species/estimate=true"/>
			<connect srcID="popMeanScale.Species" targetID="mcmc" inputName="operator" if="inposterior(constantPopIOModel.Species) and popMean.Species/estimate=true"/>

			<connect srcID="popMean.Species" targetID="updownAll:Species" inputName="down" if="inposterior(constantPopIOModel.Species) and popMean.Species/estimate=true"/>

			<connect srcID="popShape.Species" targetID="tracelog" inputName="log" if="inposterior(constantPopIOModel.Species) and popShape.Species/estimate=true"/>
			<connect srcID="popMean.Species" targetID="tracelog" inputName="log" if="inposterior(constantPopIOModel.Species) and popMean.Species/estimate=true"/>
		</subtemplate>

		<!-- Joint estimation of per-branch effective population sizes -->
		<subtemplate id="ConstantPopulations" class="starbeast2.ConstantPopulations" mainid="constPopModel.$(n)">
<![CDATA[
			<plugin id="constPopModel.$(n)" spec="starbeast2.ConstantPopulations" speciesTree="@Tree.t:Species">
				<parameter dimension="10" name="populationSizes" id="constPopSizes.$(n)" lower="0.0" value="1.0" estimate="true"/>
			</plugin>

			<distribution id="constPopSizesPrior.$(n)" spec="beast.math.distributions.Prior" x="@constPopSizes.$(n)">
				<Gamma name="distr" mode="ShapeMean">
					<parameter name="alpha" id="constPopShape.$(n)" lower="0.0" value="2.0" estimate="false"/>
					<parameter name="beta" id="constPopMean.$(n)" lower="0.0" value="1.0" estimate="true"/>
				</Gamma>
			</distribution>

			<distribution id="constPopShapePrior.$(n)" spec="beast.math.distributions.Prior" x="@constPopShape.$(n)">
				<distr spec="beast.math.distributions.Uniform" lower="0.0" upper="10000.0"/>
			</distribution>

			<distribution id="constPopMeanPrior.$(n)" spec="beast.math.distributions.Prior" x="@constPopMean.$(n)">
				<distr spec="beast.math.distributions.OneOnX"/>
			</distribution>

			<operator id="constPopSizesSwap.$(n)" parameter="@constPopSizes.$(n)" spec="SwapOperator" weight="3.0"/>
			<operator id="constPopSizesScale.$(n)" parameter="@constPopSizes.$(n)" scaleFactor="0.5" spec="ScaleOperator" weight="3.0"/>
			<operator id="constPopShapeScale.$(n)" parameter="@constPopShape.$(n)" scaleFactor="0.75" spec="ScaleOperator" weight="1.0"/>
			<operator id="constPopMeanScale.$(n)" parameter="@constPopMean.$(n)" scaleFactor="0.75" spec="ScaleOperator" weight="1.0"/>
]]>

			<connect srcID="constPopModel.Species" targetID="popModelBridge.Species" inputName="childModel" if="inposterior(constPopModel.Species)"/>
			<connect srcID="constPopModel.Species" targetID="SpeciesTreeLoggerX" inputName="populationmodel" if="inposterior(constPopModel.Species)"/>

			<connect srcID="constPopSizes.Species" targetID="state" inputName="stateNode" if="inposterior(constPopModel.Species) and constPopSizes.Species/estimate=true"/>
			<connect srcID="constPopShape.Species" targetID="state" inputName="stateNode" if="inposterior(constPopModel.Species) and constPopShape.Species/estimate=true"/>
			<connect srcID="constPopMean.Species" targetID="state" inputName="stateNode" if="inposterior(constPopModel.Species) and constPopMean.Species/estimate=true"/>

			<connect srcID="constPopSizesPrior.Species" targetID="prior" inputName="distribution" if="inposterior(constPopModel.Species) and constPopSizes.Species/estimate=true"/>
			<connect srcID="constPopShapePrior.Species" targetID="prior" inputName="distribution" if="inposterior(constPopModel.Species) and constPopShape.Species/estimate=true"/>
			<connect srcID="constPopMeanPrior.Species" targetID="prior" inputName="distribution" if="inposterior(constPopModel.Species) and constPopMean.Species/estimate=true"/>

			<connect srcID="constPopSizesSwap.Species" targetID="mcmc" inputName="operator" if="inposterior(constPopModel.Species) and constPopSizes.Species/estimate=true"/>
			<connect srcID="constPopSizesScale.Species" targetID="mcmc" inputName="operator" if="inposterior(constPopModel.Species) and constPopSizes.Species/estimate=true"/>
			<connect srcID="constPopShapeScale.Species" targetID="mcmc" inputName="operator" if="inposterior(constPopModel.Species) and constPopShape.Species/estimate=true"/>
			<connect srcID="constPopMeanScale.Species" targetID="mcmc" inputName="operator" if="inposterior(constPopModel.Species) and constPopMean.Species/estimate=true"/>

			<connect srcID="constPopSizes.Species" targetID="updownAll:Species" inputName="down" if="inposterior(constPopModel.Species) and constPopSizes.Species/estimate=true"/>
			<connect srcID="constPopMean.Species" targetID="updownAll:Species" inputName="down" if="inposterior(constPopModel.Species) and constPopMean.Species/estimate=true"/>

			<connect srcID="constPopShape.Species" targetID="tracelog" inputName="log" if="inposterior(constPopModel.Species) and constPopShape.Species/estimate=true"/>
			<connect srcID="constPopMean.Species" targetID="tracelog" inputName="log" if="inposterior(constPopModel.Species) and constPopMean.Species/estimate=true"/>
		</subtemplate>

		<!-- Joint estimation of per-branch effective population sizes -->
		<subtemplate id="LinearWithConstantRootPopulations" class="starbeast2.LinearWithConstantRoot" mainid="lwcrPopModel.$(n)">
<![CDATA[
			<plugin id="lwcrPopModel.$(n)" spec="starbeast2.LinearWithConstantRoot" speciesTree="@Tree.t:Species">
				<parameter dimension="10" name="tipPopulationSizes" id="tipPopSizes.$(n)" lower="0.0" value="1.0" estimate="true"/>
				<parameter dimension="10" name="topPopulationSizes" id="topPopSizes.$(n)" lower="0.0" value="1.0" estimate="true"/>
			</plugin>

			<distribution id="tipPopSizesPrior.$(n)" spec="beast.math.distributions.Prior" x="@tipPopSizes.$(n)">
				<Gamma name="distr">
					<parameter name="alpha" id="tipPopShape.$(n)" lower="0.0" value="4.0" estimate="false"/>
					<parameter name="beta" id="lwcrPopScale.$(n)" lower="0.0" value="1.0" estimate="true"/>
				</Gamma>
			</distribution>

			<distribution id="topPopSizesPrior.$(n)" spec="beast.math.distributions.Prior" x="@topPopSizes.$(n)">
				<Gamma name="distr" beta="@lwcrPopScale.$(n)">
					<parameter name="alpha" id="topPopShape.$(n)" lower="0.0" value="2.0" estimate="false"/>
				</Gamma>
			</distribution>

			<distribution id="tipPopShapePrior.$(n)" spec="beast.math.distributions.Prior" x="@tipPopShape.$(n)">
				<distr spec="beast.math.distributions.Uniform" lower="0.0" upper="10000.0"/>
			</distribution>

			<distribution id="topPopShapePrior.$(n)" spec="beast.math.distributions.Prior" x="@topPopShape.$(n)">
				<distr spec="beast.math.distributions.Uniform" lower="0.0" upper="10000.0"/>
			</distribution>

			<distribution id="lwcrPopScalePrior.$(n)" spec="beast.math.distributions.Prior" x="@lwcrPopScale.$(n)">
				<distr spec="beast.math.distributions.OneOnX"/>
			</distribution>

			<operator id="tipPopSizesSwap.$(n)" parameter="@tipPopSizes.$(n)" spec="SwapOperator" weight="3.0"/>
			<operator id="topPopSizesSwap.$(n)" parameter="@topPopSizes.$(n)" spec="SwapOperator" weight="3.0"/>
			<operator id="tipPopSizesScale.$(n)" parameter="@tipPopSizes.$(n)" scaleFactor="0.5" spec="ScaleOperator" weight="3.0"/>
			<operator id="topPopSizesScale.$(n)" parameter="@topPopSizes.$(n)" scaleFactor="0.5" spec="ScaleOperator" weight="3.0"/>
			<operator id="tipPopShapeScale.$(n)" parameter="@tipPopShape.$(n)" scaleFactor="0.75" spec="ScaleOperator" weight="1.0"/>
			<operator id="topPopShapeScale.$(n)" parameter="@topPopShape.$(n)" scaleFactor="0.75" spec="ScaleOperator" weight="1.0"/>
			<operator id="lwcrPopScaleScale.$(n)" parameter="@lwcrPopScale.$(n)" scaleFactor="0.75" spec="ScaleOperator" weight="1.0"/>
]]>

			<connect srcID="lwcrPopModel.Species" targetID="popModelBridge.Species" inputName="childModel" if="inposterior(lwcrPopModel.Species)"/>
			<connect srcID="lwcrPopModel.Species" targetID="SpeciesTreeLoggerX" inputName="populationmodel" if="inposterior(lwcrPopModel.Species)"/>

			<connect srcID="tipPopSizes.Species" targetID="state" inputName="stateNode" if="inposterior(lwcrPopModel.Species) and tipPopSizes.Species/estimate=true"/>
			<connect srcID="topPopSizes.Species" targetID="state" inputName="stateNode" if="inposterior(lwcrPopModel.Species) and topPopSizes.Species/estimate=true"/>
			<connect srcID="tipPopShape.Species" targetID="state" inputName="stateNode" if="inposterior(lwcrPopModel.Species) and tipPopShape.Species/estimate=true"/>
			<connect srcID="topPopShape.Species" targetID="state" inputName="stateNode" if="inposterior(lwcrPopModel.Species) and topPopShape.Species/estimate=true"/>
			<connect srcID="lwcrPopScale.Species" targetID="state" inputName="stateNode" if="inposterior(lwcrPopModel.Species) and lwcrPopScale.Species/estimate=true"/>

			<connect srcID="tipPopSizesPrior.Species" targetID="prior" inputName="distribution" if="inposterior(lwcrPopModel.Species) and tipPopSizes.Species/estimate=true"/>
			<connect srcID="topPopSizesPrior.Species" targetID="prior" inputName="distribution" if="inposterior(lwcrPopModel.Species) and topPopSizes.Species/estimate=true"/>
			<connect srcID="tipPopShapePrior.Species" targetID="prior" inputName="distribution" if="inposterior(lwcrPopModel.Species) and tipPopShape.Species/estimate=true"/>
			<connect srcID="topPopShapePrior.Species" targetID="prior" inputName="distribution" if="inposterior(lwcrPopModel.Species) and topPopShape.Species/estimate=true"/>
			<connect srcID="lwcrPopScalePrior.Species" targetID="prior" inputName="distribution" if="inposterior(lwcrPopModel.Species) and lwcrPopScale.Species/estimate=true"/>

			<connect srcID="tipPopSizesSwap.Species" targetID="mcmc" inputName="operator" if="inposterior(lwcrPopModel.Species) and tipPopSizes.Species/estimate=true"/>
			<connect srcID="topPopSizesSwap.Species" targetID="mcmc" inputName="operator" if="inposterior(lwcrPopModel.Species) and topPopSizes.Species/estimate=true"/>
			<connect srcID="tipPopSizesScale.Species" targetID="mcmc" inputName="operator" if="inposterior(lwcrPopModel.Species) and tipPopSizes.Species/estimate=true"/>
			<connect srcID="topPopSizesScale.Species" targetID="mcmc" inputName="operator" if="inposterior(lwcrPopModel.Species) and topPopSizes.Species/estimate=true"/>
			<connect srcID="tipPopShapeScale.Species" targetID="mcmc" inputName="operator" if="inposterior(lwcrPopModel.Species) and tipPopShape.Species/estimate=true"/>
			<connect srcID="topPopShapeScale.Species" targetID="mcmc" inputName="operator" if="inposterior(lwcrPopModel.Species) and topPopShape.Species/estimate=true"/>
			<connect srcID="lwcrPopScaleScale.Species" targetID="mcmc" inputName="operator" if="inposterior(lwcrPopModel.Species) and lwcrPopScale.Species/estimate=true"/>

			<connect srcID="tipPopSizes.Species" targetID="updownAll:Species" inputName="down" if="inposterior(lwcrPopModel.Species) and tipPopSizes.Species/estimate=true"/>
			<connect srcID="topPopSizes.Species" targetID="updownAll:Species" inputName="down" if="inposterior(lwcrPopModel.Species) and topPopSizes.Species/estimate=true"/>
			<connect srcID="lwcrPopScale.Species" targetID="updownAll:Species" inputName="down" if="inposterior(lwcrPopModel.Species) and lwcrPopScale.Species/estimate=true"/>

			<connect srcID="tipPopShape.Species" targetID="tracelog" inputName="log" if="inposterior(lwcrPopModel.Species) and tipPopShape.Species/estimate=true"/>
			<connect srcID="topPopShape.Species" targetID="tracelog" inputName="log" if="inposterior(lwcrPopModel.Species) and topPopShape.Species/estimate=true"/>
			<connect srcID="lwcrPopScale.Species" targetID="tracelog" inputName="log" if="inposterior(lwcrPopModel.Species) and lwcrPopScale.Species/estimate=true"/>
		</subtemplate>
	</mergewith>
</beast>
